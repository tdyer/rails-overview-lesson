![General Assembly Logo](http://i.imgur.com/ke8USTq.png)

## Objectives
* Draw Diagrams that show the flow of a HTTP Requests and Responses and the how the Model, View and Controller interact.
* Start to create a cheatsheet for all the Rails and Rack commands. 
* Create a Rails backend app.
* Review the file/directory structure for Rails.
* Initialse the DB for this Rails application.
* Start the Rails app and access it.
* Create ActiveRecord Model.
* Create a Migration.
* Migrate the Rails DB.
* Check the DB for the Table associated with the Model.
* Create a Seed file that will populate the DB.
* Populate the DB with this seed data.

### Model, View, Controller (MVC)

Rails is based on the MVC Architecture.

![MVC](mvc_archi1.png)

* A **HTTP Request** is sent from the **Client**, (browser/curl).
* The **URL Path** will determine what **Controller** will be executed.
* The **URL Path** will uniquely indentify a **Resource**, (Song, Movie, Person, ...), this is implemented as **Model**.
* This **Resource** and it's current state is persisted/stored in a **DB** table.
* The **Representation** of this **Resource** is built by the **View**. The **Representation** could be in HTML, JSON, XML, PDF and Image, etc.

We'll talk more about this architecture as we progress. And we'll see how an HTTP Request/Response flows thru and app.


## Create a new Rails application.


###Install Rails.

*Note: this can be done from within any directory*


* Let's see what versions of rails we have installed already. 

```
$ gem list |grep rails
``` 

* Let's install the lastest version of rails.

```
$ gem install rails
```

### Create a Rails application.

Create a Rails app that will use a SQLite DB

```
$ rails new movies_crud_app -T 
```

This will create a Rails application named movies_crud_app.

The -T option, or --skip-test-unit, option will exclude the tests from this Rails app. 

This will: 

* Create a directory named `movies_crud_app` that will contain all the directories, files and code for a baseline Rails application.
* Get all of the Ruby Gems needed by this application as indicated in this application's Gemfile. _These gems will be downloaded from `https:://rubygems.org` if they don't already exist on your local machine._


```ruby  
source 'https://rubygems.org'

# Bundle edge Rails instead: gem 'rails', github: 'rails/rails'                                               
gem 'rails', '4.2.5.1'
	...
	
```

* Install Ruby Gems. This will install the ruby gems on your local system/machine.

```bash
$ bundle install
```

> Note: that it may stall after the `bundle install` command. This is because Rails is loading and installing all the Ruby Gems and their dependencies for app that are listed in the `Gemfile`.

### Review Rail application directory structure.

Change into this `movies_crud_app` directory and take a look at how Rails gives you a very clear location to place all the code you'll be writing.


```
$ cd movies_crud_app
$ subl .

```

All Rails apps are structured in a very specific way. This is called **Convention Over Configuration**. The creator of Rails [David Heinemeier Hansson (DHH) ](http://david.heinemeierhansson.com/) has strong opinions about web and software development. In fact, Rails is often described as a *strongly opioniated*. 

Another words, there are very specific and consistent locations in the directory structure for code that serves a specific purpose. 

All Rails application maintain these consistent locations for code and other artifacts needed for our application.

![Rails Application Structure](RailsAppStructure.png)

The **bold** directories are where we'll be writing the vast majority of our application's code.

* __app - Where most code for you application exists.__
* bin - Scripts used by rails. _We won't be working in here._
* __config - Contains configuration and code that will be excecuted when this app is initialized, i.e. startup code and configuration.__
* __db - Contains code needed to setup the DB.__
* lib - General Ruby code that is needed by the app that doesn't fall into the Model/View/Controllers.
* log - Log files. Files generated by a running Rails app that record the operations of the app. _We'll be looking at this a lot._
* public - Mix of front-end files, (HTML, CSS, Images), that mostly generated within your web application.
* tmp - Temp files.
* vendor - Files used for 3rd party libraries that are not gems.


## Rails Environments

By default, Rails can run in three different environments.

### Development Mode

The mode the app is in when developers are writing code and developing the app. 

One great feature of this mode is that we don't have to restart the server after our changes. __Changes are automatically picked up by Rails.__

### Testing Mode

The mode the app is in when it's being tested. When we run our tests this is the mode we are running in.

### Production Mode

The mode the app is in when it's __live__, "In Production", being used online.

__By Default the Rails application will start in Development Mode.__

Take a look at the configuration for each mode.

```bash
$ cd config/environments
$ ls
development.rb  production.rb   test.rb
```

Each file will configure each of the Rails mode. 


For example, the development.rb file will configure the app so that on every HTTP Request the app's code will be reloaded. _This will pick up any changes to your code since the last request!_

```ruby
 # In the development environment your application's code is reloaded on                                     
  # every request. This slows down response time but is perfect for development                               
  # since you don't have to restart the web server when you make code changes.                                
  config.cache_classes = false
```

## Create a database for this rails app. 

**Rails applications always need a DB to store or persist it's data.**


* Create a database.

```
$ rake db:create
```

This will create __THREE__ Databases.  One for each environment.

Open up the `config/database.yml` file. This is a YAML file use to configure a DB for each Rails environment.

Notice, how each environment's database is named after the environment and app name.

__In the config/database.yml file:__

```
...
database: movies_crud_app_development
...
database: movies_crud_app_test
...
database: movies_crud_app_production
```

## Start the Rails app.
```
$ rails server
```

**Access the default Rails URL.**

In your browser, go to port 3000.

Ya, you should see the Welcome Aboard page. Rails is running!!!

## Generate a Movie Migration and Model

A Model is a Ruby class that is used to persist a specific resource in a DB table.

Use a rails generator to create a Movie model.

```
rails generate model Movie name:string rating:string desc:text length:integer
```

Notice what files are generated. What are they and what are they used for?

This will generate a Movie model and migration that will create a movies table in the DB.

**Lets look at the generated app/models/movie.rb file.**

** Let's looks at the generated movies migation in db/migration/...


## Migrate DB, Create a DB Table

Open up the the file db/schema.rb before and after the migrations are run below.

__Open up the db/migrate/20160229043142_create_movies.rb file.__

```ruby
class CreateMovies < ActiveRecord::Migration
  def change
    create_table :movies do |t|
      t.string :name
      t.string :rating
      t.text :desc
      t.integer :length

      t.timestamps null: false
    end
  end
end
```

This is the migration file that was generated above. It will create a **Table** in the **DB**. The tables will be named `movies` and it will have **Seven** columns.

* name - a column that will be a Ruby String. This is typically a 'varchar' DB column type.
* rating - a column that will be a Ruby String.
* desc - a column that will be a Ruby String. This is typically a 'text' DB column type.
* length - a column that will be Ruby Fixnum. This is typically a 'integer' DB column type.
* id - a column that represents a **PRIMARY KEY (PK)** is a Ruby Fixnum, integer. It uniquely identifies a row in the table. This is a 'integer' DB column type and **MUST** exists.
* created_at - a column that will be a Ruby DateTime object. This is  a 'datetime' DB column type.
* updated_at - a column that will be a Ruby DateTime object. This is  a 'datetime' DB column type.

> Note: the created_at and updated_at columns are created by the t.timestamps in the migration. And the id column is automatically generated for every table.


#### Apply this Migration.

This will generate the SQL to CREATE a table with the above columns and apply it to the `development` DB.

```
rake db:migrate
```

This will run the migrations to create a *movies* table that has a name, rating, desc and length columns. 

*Check the DB to confirm the existence of the movies table and the above columns*

```
rails dbconsole
```

This will bring up **psql**. *Command line utility to view the DB.*

Lets look at all the tables in the DB. And describe the movies table. 

```
sqlite>
sqlite> .schema movies
CREATE TABLE "movies" ("id" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "rating" varchar, "de\
sc" text, "length" integer, "created_at" datetime NOT NULL, "updated_at" datetime NOT NULL); 
sqlite> 
sqlite> 
```

We can see that the **DB Schema** shows we have a movies table with the correct table.

> Note: Control-D to exist the dbconsole.


## Create seed data

This will populate the `movies` table in the DB.

Add the below to db/seeds.rb

```
Movie.delete_all

Movie.create!(name: 'Affliction', rating: 'R', desc: 'Little Dark', length: 123)
Movie.create!(name: 'Mad Max', rating: 'R', desc: 'Fun, action', length: 154)
Movie.create!(name: 'Rushmore', rating: 'PG-13', desc: 'Quirky humor', length: 105)
puts "Created three Movies"
```

```
rake db:seed
```

This rake command will run the code in the db/seeds.rb file which will create three Movies in the DB using ActiveRecord.


***Check with the dbconsole**

```
SELECT * FROM movies;
```
**Check with rails console**

```
rails console
```

The rails console is *VERY* important for debugging and checking rails.  


Run the below commands in the Rails console.  *Notice the SQL that is created by each of the below ActiveRecord methods. 

```
Movie.first
Movie.second
Movie.third
Movie.all
```
What's going on here?

## Lab

* Create a Song resource in **this application**. Each Song will have a title, artist, description, price and length. 

* The title and artist are simple strings, desc is a 'text' field because it could have a lot of text. What should the price and length types be? 

* Look up the rails guide for migrations and find out.

* Create a couple of songs in the db/seeds.rb file. 

* Don't forget to use the rails dbconsole and rails console commands to verify you've created 3 songs.

